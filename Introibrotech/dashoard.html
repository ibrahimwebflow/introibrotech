<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashboard - Introibrotech</title>
    <link rel="stylesheet" href="styles/global.css" />
    <script src="scripts/supabase.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f4f4;
        }

        h1 {
            color: #1E90FF;
        }

        nav {
            margin: 20px 0;
        }

        nav a {
            margin-right: 15px;
            color: #1E90FF;
            font-weight: bold;
        }

        #content {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px #ccc;
        }
    </style>
</head>

<body>

    <h1>Welcome to Your Dashboard</h1>
    <p id="user-info">Loading user...</p>

    <nav>
        <a href="#" onclick="loadContent('learn-code')">Learn to Code</a>
        <a href="#" onclick="loadContent('learn-graphics')">Graphics</a>
        <a href="#" onclick="loadContent('ask-math')">Math Help</a>
        <a href="#" onclick="loadContent('brand-request')">Request Help</a>
        <a href="#" onclick="loadContent('my-requests')">My Requests</a>
        <a href="#" onclick="logout()">Logout</a>
    </nav>

    <div id="content">
        <p>Select a section above to begin.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user }, error } = await supabase.auth.getUser();
            if (!user) {
                alert("You're not logged in");
                window.location.href = "/login.html";
                return;
            }
            document.getElementById("user-info").textContent = "Logged in as: " + user.email;
        });

        function logout() {
            signOutUser();
        }

        function loadContent(section) {
            let html = '';
            switch (section) {
                case 'learn-code':
                    html = `
        <h3>Learn to Code</h3>
        <div id="code-courses">Loading...</div>
    `;
                    setTimeout(() => loadCourses('code'), 50);
                    break;

                case 'learn-graphics':
                    html = `
        <h3>Learn Graphics</h3>
        <div id="graphics-courses">Loading...</div>
    `;
                    setTimeout(() => loadCourses('graphics'), 50);
                    break;

                case 'ask-math':
                    html = `
        <h3>Ask a Math Question</h3>
        <form id="math-question-form">
            <label>Your Question:</label><br>
            <textarea id="question-text" rows="4" required></textarea><br><br>
            <label>Optional Image (Screenshot):</label><br>
            <input type="file" id="question-image" accept="image/*"><br><br>
            <button type="submit">Submit</button>
        </form>
        <p id="math-status"></p>
    `;
                    break;

                case 'brand-request':
                    html = `
        <h3>Request Brand Help</h3>
        <form id="brand-request-form">
            <label>Business Name:</label><br>
            <input type="text" id="business-name" required><br><br>

            <label>Why Do You Want This Service:</label><br>
            <textarea id="description" rows="4" required></textarea><br><br>

            <label>Select Services Needed:</label><br>
            <input type="checkbox" name="services" value="Website"> Website<br>
            <input type="checkbox" name="services" value="Logo"> Logo<br>
            <input type="checkbox" name="services" value="Social Media Kit"> Social Media Kit<br>
            <input type="checkbox" name="services" value="Business Card"> Business Card<br><br>

            <button type="submit">Submit Request</button>
        </form>
        <p id="request-status" style="margin-top: 10px;"></p>
    `;
                    break;

                case 'my-requests':
                    html = `
        <h3>My Brand Requests</h3>
        <div id="my-requests-list">Loading your requests...</div>
    `;
                    setTimeout(fetchMyRequests, 50);
                    // Load data from Supabase
                    break;

                default:
                    html = '<p>Select a section above to begin.</p>';
            }
            document.getElementById('content').innerHTML = html;
        }
    </script>

    <script>
        // Existing content...

        document.addEventListener('submit', async function (e) {
            if (e.target && e.target.id === 'brand-request-form') {
                e.preventDefault();
                const businessName = document.getElementById('business-name').value;
                const description = document.getElementById('description').value;
                const serviceElements = document.querySelectorAll('input[name="services"]:checked');
                const services = Array.from(serviceElements).map(e => e.value);

                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    alert("You must be logged in.");
                    return;
                }

                const { error } = await supabase
                    .from('brand_requests')
                    .insert([{
                        user_id: user.id,
                        business_name: businessName,
                        description: description,
                        services_requested: services
                    }]);

                const statusText = document.getElementById('request-status');
                if (error) {
                    statusText.textContent = "❌ Request failed: " + error.message;
                    statusText.style.color = "red";
                } else {
                    statusText.textContent = "✅ Request submitted successfully!";
                    statusText.style.color = "green";
                    e.target.reset();
                }
            }
        });

        document.addEventListener('submit', async function (e) {
            if (e.target && e.target.id === 'math-question-form') {
                e.preventDefault();
                const questionText = document.getElementById('question-text').value;
                const fileInput = document.getElementById('question-image');
                const status = document.getElementById('math-status');
                let imageUrl = null;

                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    alert("Not logged in.");
                    return;
                }

                // Upload image if selected
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${user.id}_${Date.now()}.${fileExt}`;
                    const { data, error: uploadError } = await supabase
                        .storage
                        .from('question-images')
                        .upload(fileName, file);

                    if (uploadError) {
                        status.textContent = "❌ Image upload failed.";
                        return;
                    }

                    const { data: publicUrl } = supabase
                        .storage
                        .from('question-images')
                        .getPublicUrl(fileName);

                    imageUrl = publicUrl.publicUrl;
                }

                // Insert question
                const { error: insertError } = await supabase
                    .from('questions')
                    .insert([{ user_id: user.id, question_text: questionText, image_url: imageUrl }]);

                if (insertError) {
                    status.textContent = "❌ Failed to submit: " + insertError.message;
                    status.style.color = "red";
                } else {
                    status.textContent = "✅ Question submitted successfully!";
                    status.style.color = "green";
                    e.target.reset();
                }
            }
        });

        async function loadCourses(category) {
            const containerId = category === 'code' ? 'code-courses' : 'graphics-courses';
            const container = document.getElementById(containerId);
            if (!container) return;

            const { data, error } = await supabase
                .from('courses')
                .select('*')
                .eq('category', category)
                .order('created_at', { ascending: false });

            if (error) {
                container.innerHTML = `<p>Error loading courses: ${error.message}</p>`;
                return;
            }

            if (data.length === 0) {
                container.innerHTML = "<p>No tutorials found yet.</p>";
                return;
            }

            const html = data.map(course => `
        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <h4>${course.title}</h4>
            <p>${course.description}</p>
            ${course.video_url ? `<a href="${course.video_url}" target="_blank">▶️ Watch Video</a>` : ''}
        </div>
    `).join("");

            container.innerHTML = html;
        }




        async function fetchMyRequests() {
            const container = document.getElementById('my-requests-list');

            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError || !user) {
                container.innerHTML = "<p>You must be logged in.</p>";
                return;
            }

            const { data, error } = await supabase
                .from('brand_requests')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error) {
                container.innerHTML = `<p>Error: ${error.message}</p>`;
                return;
            }

            if (data.length === 0) {
                container.innerHTML = "<p>No requests found.</p>";
                return;
            }

            // Render requests
            const listHTML = data.map(req => `
        <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
            <h4 style="margin: 0 0 5px 0;">${req.business_name}</h4>
            <p><strong>Description:</strong> ${req.description}</p>
            <p><strong>Services:</strong> ${req.services_requested.join(', ')}</p>
            <p><strong>Status:</strong> <span style="color:${getStatusColor(req.status)}">${req.status.toUpperCase()}</span></p>
            <p><strong>Progress Note:</strong> ${req.progress_note || 'N/A'}</p>
            <small>Submitted: ${new Date(req.created_at).toLocaleString()}</small>
        </div>
    `).join("");

            container.innerHTML = listHTML;
        }

        // Helper function to color status
        function getStatusColor(status) {
            switch (status) {
                case 'pending': return 'orange';
                case 'in_progress': return 'blue';
                case 'completed': return 'green';
                default: return 'gray';
            }
        }

    </script>


</body>

</html>